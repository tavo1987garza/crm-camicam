<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Camicam</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 20px;
        }
        table {
            width: 80%;
            margin: 20px auto;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #4CAF50;
            color: white;
        }
        button {
            padding: 5px 10px;
            margin: 2px;
            border: none;
            cursor: pointer;
        }
        .en-proceso { background-color: #f4c542; color: white; }
        .finalizado { background-color: #28a745; color: white; }
    </style>
</head>
<body>

    <h1>ğŸ“© CRM Camicam - GestiÃ³n de Mensajes</h1>
    <h2>ğŸ“© Mensajes Recibidos</h2>

    <!-- ğŸ”¹ Botones de filtro -->
    <button onclick="filtrarMensajes('')">ğŸ”„ Todos</button>
    <button onclick="filtrarMensajes('Nuevo')">ğŸŸ¢ Nuevos</button>
    <button onclick="filtrarMensajes('En proceso')">ğŸŸ¡ En proceso</button>
    <button onclick="filtrarMensajes('Finalizado')">ğŸ”´ Finalizados</button>

    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Plataforma</th>
                <th>Remitente</th>
                <th>Mensaje</th>
                <th>Estado</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="mensajes-table">
            <!-- AquÃ­ se insertarÃ¡n los mensajes dinÃ¡micamente -->
        </tbody>
    </table>
    <h2>ConfiguraciÃ³n</h2>
<button id="toggle-notif" onclick="toggleNotificaciones()">ğŸ”” Notificaciones: ON</button>
<button id="toggle-sonido" onclick="toggleSonido()">ğŸ”Š Sonido: ON</button>

<div id="alerta-mensaje" style="display: none; background: red; color: white; padding: 10px; margin: 10px auto; width: 50%;">
    ğŸ“© Nuevo mensaje recibido
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.4.1/socket.io.js"></script>

<script>
    // ğŸ”¹ Conectar con WebSockets y asegurar transporte WebSocket
    const socket = io.connect(window.location.origin, { transports: ["websocket", "polling"] });

    socket.on("connect", () => {
        console.log("âœ… Conectado a WebSockets.");
    });

    socket.on("connect_error", (error) => {
        console.error("âŒ Error en la conexiÃ³n WebSocket:", error);
    });

    let notificacionesActivas = true;
    let sonidoActivo = true;
    let sonidoEnProgreso = false; // ğŸ”¹ Para evitar que el sonido se repita

    // ğŸ”¹ Escuchar eventos de nuevos mensajes
    socket.on("nuevo_mensaje", (data) => {
        console.log("ğŸ“© Nuevo mensaje recibido:", data);
        filtrarMensajes(""); // Recargar mensajes en tiempo real

        if (notificacionesActivas) {
            mostrarNotificacion(data);
        }

        if (sonidoActivo) {
            reproducirSonido();
        }
    });

    // ğŸ”¹ FunciÃ³n para mostrar la notificaciÃ³n visual
    function mostrarNotificacion(data) {
        let alerta = document.getElementById("alerta-mensaje");
        alerta.textContent = `ğŸ“© Nuevo mensaje de ${data.remitente}: "${data.mensaje}"`;
        alerta.style.display = "block";

        setTimeout(() => {
            alerta.style.display = "none";
        }, 5000);
    }

    // ğŸ”¹ FunciÃ³n para reproducir sonido
    function reproducirSonido() {
        if (sonidoHabilitado && !sonidoEnProgreso) {  
            sonidoEnProgreso = true; // ğŸ”¹ Evita que se dispare varias veces seguidas
            let audio = new Audio("https://www.fesliyanstudios.com/play-mp3/4383");
    
            audio.play().then(() => {
                console.log("ğŸ”Š Sonido reproducido.");
            }).catch(error => console.log("âš ï¸ No se pudo reproducir el sonido:", error));
    
            setTimeout(() => {
                sonidoEnProgreso = false; // ğŸ”¹ Habilita nuevamente despuÃ©s de 2 segundos
            }, 2000);
        }
    }

    // ğŸ”¹ FunciÃ³n para alternar notificaciones
    function toggleNotificaciones() {
        notificacionesActivas = !notificacionesActivas;
        document.getElementById("toggle-notif").textContent = notificacionesActivas ? "ğŸ”” Notificaciones: ON" : "ğŸ”• Notificaciones: OFF";
    }

    // ğŸ”¹ FunciÃ³n para alternar sonido
    function toggleSonido() {
        sonidoActivo = !sonidoActivo;
        document.getElementById("toggle-sonido").textContent = sonidoActivo ? "ğŸ”Š Sonido: ON" : "ğŸ”ˆ Sonido: OFF";
    }

    // ğŸ”¹ Cargar mensajes en la tabla con opciÃ³n de filtrar por estado
    function filtrarMensajes(estado) {
        let url = "/mensajes";
        if (estado) {
            url += "?estado=" + encodeURIComponent(estado);
        }

        fetch(url)
            .then(response => response.json())
            .then(mensajes => {
                let tabla = document.getElementById("mensajes-table");
                tabla.innerHTML = "";  // Limpiar la tabla antes de recargar

                mensajes.forEach(msg => {
                    let row = tabla.insertRow();
                    row.insertCell(0).textContent = msg.id;
                    row.insertCell(1).textContent = msg.plataforma;
                    row.insertCell(2).textContent = msg.remitente;
                    row.insertCell(3).textContent = msg.mensaje;
                    row.insertCell(4).textContent = msg.estado;

                    let acciones = row.insertCell(5);
                    let botones = "";

                    if (msg.estado === "Nuevo") {
                        botones += `<button class="en-proceso" onclick="cambiarEstado(${msg.id}, 'En proceso')">ğŸŸ¡ En Proceso</button>`;
                    } else if (msg.estado === "En proceso") {
                        botones += `<button class="finalizado" onclick="cambiarEstado(${msg.id}, 'Finalizado')">ğŸ”´ Finalizar</button>`;
                    } else {
                        botones += "âœ”ï¸ Finalizado";
                    }

                    // Agregar botÃ³n de eliminar
                    botones += ` <button class="eliminar" onclick="eliminarMensaje(${msg.id})">ğŸ—‘ï¸ Eliminar</button>`;
                    acciones.innerHTML = botones;
                });
            });
    }

    // ğŸ”¹ Cambiar estado del mensaje
    function cambiarEstado(id, nuevoEstado) {
        fetch("/actualizar_estado", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id: id, estado: nuevoEstado })
        })
            .then(response => response.json())
            .then(data => {
                alert(data.mensaje);
                filtrarMensajes(""); // Recargar tabla despuÃ©s de cambiar estado
            });
    }

    // ğŸ”¹ FunciÃ³n para eliminar un mensaje
    function eliminarMensaje(id) {
        if (confirm("Â¿EstÃ¡s seguro de que quieres eliminar este mensaje? Esta acciÃ³n no se puede deshacer.")) {
            fetch("/eliminar_mensaje", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ id: id })
            })
                .then(response => response.json())
                .then(data => {
                    alert(data.mensaje);
                    filtrarMensajes(""); // Recargar tabla despuÃ©s de eliminar
                });
        }
    }

    // ğŸ”¹ Cargar mensajes al inicio
    window.onload = function () {
        filtrarMensajes("");
    };
</script>


</body>
</html>
